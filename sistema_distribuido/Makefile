# -*- coding: utf-8 -*-
# Makefile - Sistema Distribuido de PrÃ©stamo de Libros
# Suite de verificaciÃ³n minuciosa para validar cumplimiento de Entrega #1

.PHONY: help up down test demo evidence logs clean status ips wait-gc

# ConfiguraciÃ³n
DOCKER_COMPOSE = docker compose
LOGS_DIR = logs
SCRIPTS_DIR = scripts

# Colores para output
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m # No Color

# Ayuda por defecto
help: ## Mostrar ayuda
	@echo "$(GREEN)Sistema Distribuido de PrÃ©stamo de Libros$(NC)"
	@echo "$(GREEN)============================================$(NC)"
	@echo ""
	@echo "$(YELLOW)Comandos disponibles:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)Ejemplos:$(NC)"
	@echo "  make up          # Levantar servicios bÃ¡sicos"
	@echo "  make test        # Ejecutar suite completa de pruebas"
	@echo "  make demo        # Levantar con PS para demostraciÃ³n"
	@echo "  make evidence    # Recolectar evidencias del sistema"

# Objetivos principales
up: ## Levantar servicios bÃ¡sicos (GC + Actores)
	@echo "$(GREEN)ğŸš€ Levantando servicios bÃ¡sicos...$(NC)"
	@$(DOCKER_COMPOSE) up -d gc actor_devolucion actor_renovacion
	@echo "$(GREEN)âœ… Servicios bÃ¡sicos levantados$(NC)"
	@echo "$(YELLOW)ğŸ“‹ Estado:$(NC)"
	@$(DOCKER_COMPOSE) ps

down: ## Detener todos los servicios
	@echo "$(YELLOW)ğŸ›‘ Deteniendo todos los servicios...$(NC)"
	@$(DOCKER_COMPOSE) down -v
	@echo "$(GREEN)âœ… Servicios detenidos$(NC)"

test: ## Ejecutar suite completa de pruebas
	@echo "$(GREEN)ğŸ§ª Ejecutando suite completa de pruebas...$(NC)"
	@echo "$(YELLOW)ğŸ“Š Esto incluye:$(NC)"
	@echo "   - Levantar servicios bÃ¡sicos"
	@echo "   - Verificar IPs internas (â‰¥2 computadores)"
	@echo "   - Test end-to-end (REQ/REP + PUB/SUB)"
	@echo "   - Test pub/sub visibilidad"
	@echo "   - Test workload con archivo"
	@echo "   - RecolecciÃ³n de evidencias"
	@echo ""
	@$(SCRIPTS_DIR)/run_tests.sh
	@echo ""
	@echo "$(GREEN)ğŸ“Š Resultados disponibles en: $(LOGS_DIR)/$(NC)"

demo: ## Levantar con PS para demostraciÃ³n
	@echo "$(GREEN)ğŸ­ Levantando sistema completo para demostraciÃ³n...$(NC)"
	@$(DOCKER_COMPOSE) --profile demo up -d
	@echo "$(GREEN)âœ… Sistema completo levantado$(NC)"
	@echo "$(YELLOW)ğŸ“‹ Estado:$(NC)"
	@$(DOCKER_COMPOSE) ps
	@echo ""
	@echo "$(YELLOW)ğŸ“ Para ver logs en tiempo real:$(NC)"
	@echo "  make logs"

evidence: ## Recolectar evidencias del sistema
	@echo "$(GREEN)ğŸ“Š Recolectando evidencias del sistema...$(NC)"
	@$(SCRIPTS_DIR)/collect_evidence.sh
	@echo "$(GREEN)âœ… Evidencias recolectadas en: $(LOGS_DIR)/evidence/$(NC)"

logs: ## Mostrar logs de todos los servicios
	@echo "$(GREEN)ğŸ“ Mostrando logs de todos los servicios...$(NC)"
	@$(DOCKER_COMPOSE) logs --tail=200 gc actor_devolucion actor_renovacion ps || true
	@echo "$(GREEN)âœ… Logs mostrados$(NC)"

# Objetivos de diagnÃ³stico
status: ## Mostrar estado de contenedores
	@echo "$(GREEN)ğŸ“‹ Estado de contenedores:$(NC)"
	@$(DOCKER_COMPOSE) ps
	@echo ""
	@echo "$(GREEN)ğŸ³ Contenedores Docker:$(NC)"
	@docker ps --filter "name=gc\|actor_\|ps\|tester" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

ips: ## Mostrar IPs internas de contenedores
	@echo "$(GREEN)ğŸŒ Obteniendo IPs internas...$(NC)"
	@$(SCRIPTS_DIR)/show_ips.sh

wait-gc: ## Esperar hasta que GC estÃ© listo
	@echo "$(GREEN)â³ Esperando que GC estÃ© listo...$(NC)"
	@$(SCRIPTS_DIR)/wait_for_gc.sh

# Objetivos de desarrollo
build: ## Construir imÃ¡genes Docker
	@echo "$(GREEN)ğŸ”¨ Construyendo imÃ¡genes Docker...$(NC)"
	@$(DOCKER_COMPOSE) build
	@echo "$(GREEN)âœ… ImÃ¡genes construidas$(NC)"

rebuild: ## Reconstruir imÃ¡genes Docker
	@echo "$(GREEN)ğŸ”„ Reconstruyendo imÃ¡genes Docker...$(NC)"
	@$(DOCKER_COMPOSE) build --no-cache
	@echo "$(GREEN)âœ… ImÃ¡genes reconstruidas$(NC)"

# Objetivos de pruebas especÃ­ficas
test-e2e: ## Ejecutar solo test end-to-end
	@echo "$(GREEN)ğŸ§ª Ejecutando test end-to-end...$(NC)"
	@$(DOCKER_COMPOSE) run --rm tester python -m pytest -v tests/test_end_to_end.py

test-pubsub: ## Ejecutar solo test pub/sub
	@echo "$(GREEN)ğŸ§ª Ejecutando test pub/sub...$(NC)"
	@$(DOCKER_COMPOSE) run --rm tester python -m pytest -v tests/test_pubsub_visibility.py

test-workload: ## Ejecutar solo test workload
	@echo "$(GREEN)ğŸ§ª Ejecutando test workload...$(NC)"
	@$(DOCKER_COMPOSE) --profile demo up -d ps
	@$(DOCKER_COMPOSE) run --rm tester python -m pytest -v tests/test_file_workload.py

# Objetivos de limpieza
clean: ## Limpiar contenedores, volÃºmenes y logs
	@echo "$(YELLOW)ğŸ§¹ Limpiando sistema...$(NC)"
	@$(DOCKER_COMPOSE) down -v --remove-orphans
	@docker system prune -f
	@rm -rf $(LOGS_DIR)/*
	@echo "$(GREEN)âœ… Sistema limpiado$(NC)"

clean-logs: ## Limpiar solo logs
	@echo "$(YELLOW)ğŸ§¹ Limpiando logs...$(NC)"
	@rm -rf $(LOGS_DIR)/*
	@echo "$(GREEN)âœ… Logs limpiados$(NC)"

clean-containers: ## Limpiar solo contenedores
	@echo "$(YELLOW)ğŸ§¹ Limpiando contenedores...$(NC)"
	@$(DOCKER_COMPOSE) down -v --remove-orphans
	@echo "$(GREEN)âœ… Contenedores limpiados$(NC)"

# Objetivos de informaciÃ³n
info: ## Mostrar informaciÃ³n del sistema
	@echo "$(GREEN)â„¹ï¸  InformaciÃ³n del Sistema$(NC)"
	@echo "$(GREEN)========================$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ³ Docker:$(NC)"
	@docker --version
	@echo ""
	@echo "$(YELLOW)ğŸ™ Docker Compose:$(NC)"
	@$(DOCKER_COMPOSE) version
	@echo ""
	@echo "$(YELLOW)ğŸ“ Estructura:$(NC)"
	@echo "  - Servicios: 4 (GC + 2 Actores + PS)"
	@echo "  - Tests: 3 (end-to-end, pub/sub, workload)"
	@echo "  - Scripts: 4 (orquestaciÃ³n y diagnÃ³stico)"
	@echo "  - DocumentaciÃ³n: 5 archivos"
	@echo ""
	@echo "$(YELLOW)ğŸ”Œ Puertos:$(NC)"
	@echo "  - GC REQ/REP: 5001"
	@echo "  - GC PUB/SUB: 5002"
	@echo ""
	@echo "$(YELLOW)ğŸ“Š Requisitos Entrega #1:$(NC)"
	@echo "  - â‰¥3 procesos: âœ… (4 procesos)"
	@echo "  - â‰¥2 computadores: âœ… (IPs distintas)"
	@echo "  - REQ/REP: âœ… (PS â†” GC)"
	@echo "  - PUB/SUB: âœ… (GC â†’ Actores)"
	@echo "  - Operaciones: âœ… (RENOVACIÃ“N + DEVOLUCIÃ“N)"
	@echo "  - Archivo de carga: âœ… (PS procesa solicitudes.txt)"

# Objetivos de validaciÃ³n
validate: ## Validar configuraciÃ³n del sistema
	@echo "$(GREEN)ğŸ” Validando configuraciÃ³n del sistema...$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“‹ Verificando archivos requeridos:$(NC)"
	@test -f docker-compose.yml || (echo "$(RED)âŒ docker-compose.yml no encontrado$(NC)" && exit 1)
	@test -f requirements.txt || (echo "$(RED)âŒ requirements.txt no encontrado$(NC)" && exit 1)
	@test -d tests/ || (echo "$(RED)âŒ Directorio tests/ no encontrado$(NC)" && exit 1)
	@test -d scripts/ || (echo "$(RED)âŒ Directorio scripts/ no encontrado$(NC)" && exit 1)
	@test -d data/ || (echo "$(RED)âŒ Directorio data/ no encontrado$(NC)" && exit 1)
	@echo "$(GREEN)âœ… Archivos requeridos encontrados$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ”§ Verificando scripts ejecutables:$(NC)"
	@test -x scripts/run_tests.sh || (echo "$(RED)âŒ scripts/run_tests.sh no es ejecutable$(NC)" && exit 1)
	@test -x scripts/collect_evidence.sh || (echo "$(RED)âŒ scripts/collect_evidence.sh no es ejecutable$(NC)" && exit 1)
	@test -x scripts/show_ips.sh || (echo "$(RED)âŒ scripts/show_ips.sh no es ejecutable$(NC)" && exit 1)
	@test -x scripts/wait_for_gc.sh || (echo "$(RED)âŒ scripts/wait_for_gc.sh no es ejecutable$(NC)" && exit 1)
	@echo "$(GREEN)âœ… Scripts ejecutables$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“Š Verificando datos de prueba:$(NC)"
	@test -f data/libros.json || (echo "$(RED)âŒ data/libros.json no encontrado$(NC)" && exit 1)
	@test -f data/solicitudes.txt || (echo "$(RED)âŒ data/solicitudes.txt no encontrado$(NC)" && exit 1)
	@echo "$(GREEN)âœ… Datos de prueba encontrados$(NC)"
	@echo ""
	@echo "$(GREEN)âœ… ConfiguraciÃ³n del sistema vÃ¡lida$(NC)"

# Objetivo por defecto
.DEFAULT_GOAL := help
